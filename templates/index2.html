<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Real Estate Assistant - Pune Properties</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chat-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .filter-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 80%;
        }

        .user-message {
            background: #3498db;
            color: white;
            margin-left: auto;
        }

        .bot-message {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .filter-group input, .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .results-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #3498db;
            color: white;
            border-bottom-color: #2980b9;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .properties-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .properties-table th,
        .properties-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .properties-table th {
            background: #34495e;
            color: white;
            font-weight: 600;
        }

        .properties-table tr:hover {
            background: #f8f9fa;
        }

        .price-positive {
            color: #27ae60;
            font-weight: 600;
        }

        .price-negative {
            color: #e74c3c;
            font-weight: 600;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .analysis-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .analysis-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .analysis-card .value {
            font-size: 1.5em;
            font-weight: 600;
            color: #3498db;
        }

        .insights-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .insights-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .insights-section p {
            line-height: 1.6;
            color: #34495e;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .loading::after {
            content: "...";
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60% { content: "..."; }
            80%, 100% { content: ""; }
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .context-indicator {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Pune Real Estate Assistant</h1>
            <span id="statusIndicator" class="status-indicator status-connected">Connected</span>
        </div>
            <!-- Chat Section -->
            <div class="chat-section">
                <h2 class="section-title">üí¨ Smart Property Chat</h2>
                <div id="contextIndicator" class="context-indicator" style="display: none;">
                    Building on previous conversation...
                </div>
                <div id="chatContainer" class="chat-container">
                    <div class="message bot-message">
                        <strong>AI Assistant:</strong> Hello! I'm your intelligent real estate assistant. I can help you find properties, analyze market trends, and provide deep insights. Try asking me something like "Show me 2BHK properties in Baner under 60 lakhs" or "What's the price range for 3BHK in Kothrud?"
                    </div>
                </div>
                <div class="input-group">
                    <input type="text" id="messageInput" placeholder="Ask me about properties, prices, or market trends..." />
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>
                <div class="input-group">
                    <button class="btn btn-secondary" onclick="resetSession()">Reset Session</button>
                    <button class="btn btn-secondary" onclick="getInsights()">Get Insights</button>
                </div>
            </div>


        <!-- Results Section -->
        <div class="results-section">
            <h2 class="section-title">üìä Search Results & Analysis</h2>

            <div class="tabs">
                <button class="tab active" onclick="showTab('properties')">Properties</button>
                <button class="tab" onclick="showTab('analysis')">Market Analysis</button>
                <button class="tab" onclick="showTab('insights')">AI Insights</button>
                <button class="tab" onclick="showTab('nearby')">Nearby Properties</button>
            </div>

            <!-- Properties Tab -->
            <div id="properties" class="tab-content active">
                <div id="propertiesLoading" class="loading" style="display: none;">Loading properties</div>
                <div id="propertiesTable"></div>
            </div>

            <!-- Analysis Tab -->
            <div id="analysis" class="tab-content">
                <div id="analysisLoading" class="loading" style="display: none;">Analyzing market data</div>
                <div id="analysisContent"></div>
            </div>

            <!-- Insights Tab -->
            <div id="insights" class="tab-content">
                <div id="insightsLoading" class="loading" style="display: none;">Generating insights</div>
                <div id="insightsContent"></div>
            </div>

            <!-- Nearby Properties Tab -->
            <div id="nearby" class="tab-content">
                <div id="nearbyLoading" class="loading" style="display: none;">Finding nearby properties</div>
                <div id="nearbyContent"></div>
            </div>
        </div>
    </div>
    <!-- Filter Section -->
            <div class="filter-section">
                <h2 class="section-title">üîç Advanced Filters</h2>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>Location</label>
                        <select id="locationFilter">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>BHK</label>
                        <select id="bhkFilter">
                            <option value="">Any BHK</option>
                            <option value="1">1 BHK</option>
                            <option value="2">2 BHK</option>
                            <option value="3">3 BHK</option>
                            <option value="4">4 BHK</option>
                            <option value="5">5+ BHK</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Min Price (Lakhs)</label>
                        <input type="number" id="minPriceFilter" placeholder="e.g., 30">
                    </div>
                    <div class="filter-group">
                        <label>Max Price (Lakhs)</label>
                        <input type="number" id="maxPriceFilter" placeholder="e.g., 100">
                    </div>
                    <div class="filter-group">
                        <label>Min Area (Sq Ft)</label>
                        <input type="number" id="minAreaFilter" placeholder="e.g., 800">
                    </div>
                    <div class="filter-group">
                        <label>Max Area (Sq Ft)</label>
                        <input type="number" id="maxAreaFilter" placeholder="e.g., 2000">
                    </div>
                    <div class="filter-group">
                        <label>Area Type</label>
                        <select id="areaTypeFilter">
                            <option value="">Any Type</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Availability</label>
                        <select id="availabilityFilter">
                            <option value="">Any Status</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="applyFilters()" style="width: 100%;">Apply Filters</button>
            </div>

    <script>
        let currentFilters = {};
        let conversationContext = 0;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadMarketData();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        async function loadMarketData() {
            try {
                const response = await fetch('/get_market_data');
                const data = await response.json();

                populateDropdowns(data);
                updateStatusIndicator(true);
            } catch (error) {
                console.error('Error loading market data:', error);
                updateStatusIndicator(false);
            }
        }

        function populateDropdowns(data) {
            const locationSelect = document.getElementById('locationFilter');
            const areaTypeSelect = document.getElementById('areaTypeFilter');
            const availabilitySelect = document.getElementById('availabilityFilter');

            // Populate locations
            data.locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationSelect.appendChild(option);
            });

            // Populate area types
            data.area_types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                areaTypeSelect.appendChild(option);
            });

            // Populate availability
            data.availability_types.forEach(availability => {
                const option = document.createElement('option');
                option.value = availability;
                option.textContent = availability;
                availabilitySelect.appendChild(option);
            });
        }

        function updateStatusIndicator(connected) {
            const indicator = document.getElementById('statusIndicator');
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                indicator.textContent = 'Connected';
            } else {
                indicator.className = 'status-indicator status-error';
                indicator.textContent = 'Error';
            }
        }

        function showContextIndicator(show) {
            const indicator = document.getElementById('contextIndicator');
            indicator.style.display = show ? 'block' : 'none';
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            addMessageToChat(message, 'user');
            messageInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                if (data.error) {
                    addMessageToChat(`Error: ${data.error}`, 'bot');
                } else {
                    handleChatResponse(data);
                }

                conversationContext = data.conversation_context || 0;
                showContextIndicator(conversationContext > 0);

            } catch (error) {
                addMessageToChat(`Error: ${error.message}`, 'bot');
                updateStatusIndicator(false);
            }
        }

        function handleChatResponse(data) {
            const response = data.response;

            if (response.error) {
                addMessageToChat(`Error: ${response.error}`, 'bot');
                return;
            }

            // Add insights to chat
            if (response.insights) {
                addMessageToChat(response.insights, 'bot');
            }

            // Update results
            if (response.filtered_properties) {
                displayProperties(response.filtered_properties);
            }

            if (response.analysis) {
                displayAnalysis(response.analysis);
            }

            if (response.nearby_properties) {
                displayNearbyProperties(response.nearby_properties);
            }

            // Show summary message
            const summary = generateSummaryMessage(response);
            addMessageToChat(summary, 'bot');
        }

        function generateSummaryMessage(response) {
            const total = response.analysis?.total_properties || 0;
            const priceRange = response.analysis?.price_range;

            if (total === 0) {
                return "No properties found matching your criteria. Try adjusting your search parameters.";
            }

            let summary = `Found ${total} properties`;
            if (priceRange) {
                summary += ` with prices ranging from ‚Çπ${priceRange.min.toFixed(2)}L to ‚Çπ${priceRange.max.toFixed(2)}L (avg: ‚Çπ${priceRange.avg.toFixed(2)}L)`;
            }

            return summary + ". Check the results tabs below for detailed analysis.";
        }

        function addMessageToChat(message, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            const senderLabel = sender === 'user' ? 'You' : 'AI Assistant';
            messageDiv.innerHTML = `<strong>${senderLabel}:</strong> ${message}`;

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function applyFilters() {
            const filters = {
                location: document.getElementById('locationFilter').value,
                bhk: document.getElementById('bhkFilter').value ? parseInt(document.getElementById('bhkFilter').value) : null,
                min_price: document.getElementById('minPriceFilter').value ? parseFloat(document.getElementById('minPriceFilter').value) : null,
                max_price: document.getElementById('maxPriceFilter').value ? parseFloat(document.getElementById('maxPriceFilter').value) : null,
                min_area: document.getElementById('minAreaFilter').value ? parseFloat(document.getElementById('minAreaFilter').value) : null,
                max_area: document.getElementById('maxAreaFilter').value ? parseFloat(document.getElementById('maxAreaFilter').value) : null,
                area_type: document.getElementById('areaTypeFilter').value,
                availability: document.getElementById('availabilityFilter').value
            };

            // Remove null values
            Object.keys(filters).forEach(key => {
                if (filters[key] === null || filters[key] === '') {
                    delete filters[key];
                }
            });

            currentFilters = filters;

            try {
                showLoading('properties');
                showLoading('analysis');

                const response = await fetch('/filter_properties', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filters)
                });

                const data = await response.json();

                if (data.error) {
                    hideLoading('properties');
                    hideLoading('analysis');
                    alert(`Error: ${data.error}`);
                } else {
                    displayProperties(data.properties);
                    displayAnalysis(data.analysis);
                    hideLoading('properties');
                    hideLoading('analysis');
                }

            } catch (error) {
                hideLoading('properties');
                hideLoading('analysis');
                alert(`Error: ${error.message}`);
            }
        }

        function displayProperties(properties) {
            const container = document.getElementById('propertiesTable');

            if (!properties || properties.length === 0) {
                container.innerHTML = '<p>No properties found matching your criteria.</p>';
                return;
            }

            let html = `
                <table class="properties-table">
                    <thead>
                        <tr>
                            <th>Location</th>
                            <th>BHK</th>
                            <th>Area (Sq Ft)</th>
                            <th>Price (‚ÇπL)</th>
                            <th>Predicted (‚ÇπL)</th>
                            <th>Price/Sq Ft</th>
                            <th>Society</th>
                            <th>Availability</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            properties.forEach(property => {
                const priceDiff = property.price_difference || 0;
                const priceClass = priceDiff > 0 ? 'price-positive' : priceDiff < 0 ? 'price-negative' : '';

                html += `
                    <tr>
                        <td>${property.site_location}</td>
                        <td>${property.bhk}</td>
                        <td>${property.total_sqft}</td>
                        <td>‚Çπ${property.price.toFixed(2)}</td>
                        <td class="${priceClass}">‚Çπ${(property.predicted_price || property.price).toFixed(2)}</td>
                        <td>‚Çπ${Math.round(property.price_per_sqft)}</td>
                        <td>${property.society || 'N/A'}</td>
                        <td>${property.availability}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function displayAnalysis(analysis) {
            const container = document.getElementById('analysisContent');

            if (!analysis || analysis.total_properties === 0) {
                container.innerHTML = '<p>No analysis available.</p>';
                return;
            }

            const html = `
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4>Total Properties</h4>
                        <div class="value">${analysis.total_properties}</div>
                    </div>
                    <div class="analysis-card">
                        <h4>Price Range</h4>
                        <div class="value">‚Çπ${analysis.price_range.min.toFixed(2)}L - ‚Çπ${analysis.price_range.max.toFixed(2)}L</div>
                    </div>
                    <div class="analysis-card">
                        <h4>Average Price</h4>
                        <div class="value">‚Çπ${analysis.price_range.avg.toFixed(2)}L</div>
                    </div>
                    <div class="analysis-card">
                        <h4>Median Price</h4>
                        <div class="value">‚Çπ${analysis.price_range.median.toFixed(2)}L</div>
                    </div>
                    <div class="analysis-card">
                        <h4>Avg Area</h4>
                        <div class="value">${Math.round(analysis.area_range.avg)} Sq Ft</div>
                    </div>
                    <div class="analysis-card">
                        <h4>Avg Price/Sq Ft</h4>
                        <div class="value">‚Çπ${Math.round(analysis.price_per_sqft.avg)}</div>
                    </div>
                </div>

                <div class="insights-section">
                    <h3>Location Distribution</h3>
                    ${Object.entries(analysis.location_distribution).map(([location, count]) =>
                        `<p><strong>${location}:</strong> ${count} properties</p>`
                    ).join('')}
                </div>

                <div class="insights-section">
                    <h3>Area Type Distribution</h3>
                    ${Object.entries(analysis.area_type_distribution).map(([type, count]) =>
                        `<p><strong>${type}:</strong> ${count} properties</p>`
                    ).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        function displayNearbyProperties(content) {
            const container = document.getElementById('nearbyContent');
            container.innerHTML = `
                <div class="insights-section">
                    <h3>Nearby Properties & Market Trends</h3>
                    <div style="white-space: pre-wrap;">${content}</div>
                </div>
            `;
        }

        async function getInsights() {
            try {
                showLoading('insights');

                const response = await fetch('/get_insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        location: currentFilters.location,
                        requirements: currentFilters
                    })
                });

                const data = await response.json();

                if (data.error) {
                    alert(`Error: ${data.error}`);
                } else {
                    displayInsights(data.insights);
                    if (data.nearby_properties) {
                        displayNearbyProperties(data.nearby_properties);
                    }
                }

                hideLoading('insights');
                showTab('insights');

            } catch (error) {
                hideLoading('insights');
                alert(`Error: ${error.message}`);
            }
        }

        function displayInsights(insights) {
            const container = document.getElementById('insightsContent');
            container.innerHTML = `
                <div class="insights-section">
                    <h3>AI-Powered Market Insights</h3>
                    <div style="white-space: pre-wrap; line-height: 1.6;">${insights}</div>
                </div>
            `;
        }

        async function resetSession() {
            try {
                await fetch('/reset_session', { method: 'POST' });

                // Clear chat
                document.getElementById('chatContainer').innerHTML = `
                    <div class="message bot-message">
                        <strong>AI Assistant:</strong> Session reset! I'm ready to help you find properties again.
                    </div>
                `;

                // Clear filters
                document.getElementById('locationFilter').value = '';
                document.getElementById('bhkFilter').value = '';
                document.getElementById('minPriceFilter').value = '';
                document.getElementById('maxPriceFilter').value = '';
                document.getElementById('minAreaFilter').value = '';
                document.getElementById('maxAreaFilter').value = '';
                document.getElementById('areaTypeFilter').value = '';
                document.getElementById('availabilityFilter').value = '';

                // Clear results
                document.getElementById('propertiesTable').innerHTML = '';
                document.getElementById('analysisContent').innerHTML = '';
                document.getElementById('insightsContent').innerHTML = '';
                document.getElementById('nearbyContent').innerHTML = '';

                currentFilters = {};
                conversationContext = 0;
                showContextIndicator(false);

            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to selected tab
            event.target.classList.add('active');
        }

        function showLoading(tabName) {
            const loadingElement = document.getElementById(tabName + 'Loading');
            if (loadingElement) {
                loadingElement.style.display = 'block';
            }
        }

        function hideLoading(tabName) {
            const loadingElement = document.getElementById(tabName + 'Loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }

    </script>
</body>
</html>